<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Development issues &mdash; PyOSCARS v1.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '',
          VERSION:     '1.0',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: ''
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/interface.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="contents" title="Global table of contents" href="contents.html" />
    <link rel="index" title="Global index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="top" title="PyOSCARS v1.0 documentation" href="index.html" />
    <link rel="next" title="Getting help" href="help.html" />
    <link rel="prev" title="OSCARSNotify receiver" href="receiver.html" />
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="help.html" title="Getting help"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="receiver.html" title="OSCARSNotify receiver"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">PyOSCARS v1.0 documentation</a> &raquo;</li>
      </ul>
    </div>
    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  
  <div class="section" id="development-issues">
<h1 id="development-issues">Development issues<a class="headerlink" href="#development-issues" title="Permalink to this headline">¶</a></h1>
<p>PyOSCARS is built on top of different Python libraries, of which the most
prominent is probably <a class="reference external" href="http://pywebsvcs.sourceforge.net/">ZSI</a>, the SOAP
library.</p>
<p>Since IDCs are providing their services through
<a class="reference external" href="http://ws.apache.org/axis2/">Apache Axis2</a>, it was crucial to make sure that
the two software could exchange information.</p>
<p>What follows is a brief account of the major problems encountered during
development, as well as their solutions.</p>
<div class="section" id="soap">
<h2 id="soap">SOAP<a class="headerlink" href="#soap" title="Permalink to this headline">¶</a></h2>
<p>ZSI implements SOAP 1.1, while the IDC interface requires SOAP 1.2.</p>
<p>This is a serious problem, because the two are unable to speak to each other,
and it also prevents the client from automatically generating code from the WSDL
files.</p>
<div class="section" id="namespaces">
<h3 id="namespaces">Namespaces<a class="headerlink" href="#namespaces" title="Permalink to this headline">¶</a></h3>
<p>Solving this problem required changing all the SOAP 1.1 namespace references in
the ZSI code to their respective SOAP 1.2 counterparts.</p>
</div>
<div class="section" id="faults">
<h3 id="faults">Faults<a class="headerlink" href="#faults" title="Permalink to this headline">¶</a></h3>
<p>A SOAP fault is a special kind of message (defined in the SOAP WSDL) that is
used to notify problems.</p>
<p>Since the models for SOAP 1.1 fault messages are hardwired in ZSI, which causes
it to fail whenever Axis2 sends a SOAP 1.2 fault messages its way, a rewrite of
the fault handling code was required.</p>
<p>As a result, SOAP faults are now thrown as Python exceptions, passing over the
message that the server sent as motivation.</p>
</div>
</div>
<div class="section" id="ws-security-and-xml-dsig">
<span id="ws-sec"></span><h2 id="ws-security-and-xml-dsig"><span id="ws-sec"></span>WS-Security and XML-DSig<a class="headerlink" href="#ws-security-and-xml-dsig" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://www.oasis-open.org/committees/wss/">OASIS Web Services Security</a>
(WS-Security) is used to guarantee the integrity of messages as they travel from
the client to the server, and to identify the client by associating the digital
certificate in the message to the corresponding IDC user.
All outgoing messages are signed by the client according to the
<a class="reference external" href="http://www.w3.org/TR/xmldsig-core/">XML Signature Syntax and Processing W3C Recommendation</a>
(XML-DSig).</p>
<p>ZSI provides no support for WS-Security, but has the ability to use a so-called
<tt class="docutils literal"><span class="pre">SignatureHandler</span></tt>, which is called to sign outgoing requests and verify
incoming responses.
WS-Security has been implemented in PyOSCARS as a <tt class="docutils literal"><span class="pre">SignatureHandler</span></tt> which
only handles signing, as no verification is currently needed.</p>
<div class="section" id="xml-canonicalization">
<h3 id="xml-canonicalization">XML Canonicalization<a class="headerlink" href="#xml-canonicalization" title="Permalink to this headline">¶</a></h3>
<p>WS-Security relies on <a class="reference external" href="http://www.w3.org/TR/xml-exc-c14n/">Exclusive XML Canonicalization</a>
to make sure that similar XML documents (or parts thereof) are represented in
the same way, thus allowing signature verification.</p>
<p>The process involves two canonicalizations, namely:</p>
<ul class="simple">
<li>Canonicalization of the elements with a <tt class="docutils literal"><span class="pre">wsu:Id</span></tt> attribute, which are then
referred to in the <tt class="docutils literal"><span class="pre">&lt;SignedInfo&gt;</span></tt> element, along with their hash values;</li>
<li>Canonicalization of the <tt class="docutils literal"><span class="pre">&lt;SignedInfo&gt;</span></tt> element, which is then hashed and
signed to obtain the final <tt class="docutils literal"><span class="pre">&lt;SignatureValue&gt;</span></tt> element value.</li>
</ul>
<p>Regarding the first canonicalization, the IDC seems to accept only messages in
which the <tt class="docutils literal"><span class="pre">&lt;SignedInfo&gt;</span></tt> element refers only to the SOAP body, despite other
elements (for example the <tt class="docutils literal"><span class="pre">&lt;Timestamp&gt;</span></tt>) having the <tt class="docutils literal"><span class="pre">wsu:Id</span></tt> attribute.
Moreover, this first canonicalization has to be carried out by suppressing all
namespace prefixes, but <tt class="docutils literal"><span class="pre">SOAP-ENV</span></tt> and <tt class="docutils literal"><span class="pre">wsu</span></tt>.</p>
<p>The second canonicalization, instead, is carried out on the <tt class="docutils literal"><span class="pre">&lt;SignedInfo&gt;</span></tt>
element only, by suppressing all namespaces prefixes.</p>
</div>
<div class="section" id="signature-generation">
<h3 id="signature-generation">Signature generation<a class="headerlink" href="#signature-generation" title="Permalink to this headline">¶</a></h3>
<p>Signatures are generated using <a class="reference external" href="http://chandlerproject.org/Projects/MeTooCrypto">M2Crypto</a>,
which is based on the famous <a class="reference external" href="http://www.openssl.org/">OpenSSL</a> library.</p>
<p>Both OpenSSL and M2Crypto prepend to the actual signature value a byte count,
which needs to be eliminated according to the XML-DSig standard.
This is done by the <tt class="docutils literal"><span class="pre">_i2osp</span></tt> function in <tt class="docutils literal"><span class="pre">wssecurity.py</span></tt>:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">_i2osp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signatureValue</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Converts a OpenSSL/M2Crypto DSA signature to WS-Security format&#39;&#39;&#39;</span>

    <span class="c"># Remove leading zeros</span>
    <span class="n">signatureValue</span> <span class="o">=</span> <span class="n">signatureValue</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># Find out how many bytes will follow</span>
    <span class="n">takeHowManyBytes</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">signatureValue</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>

    <span class="c"># Take that many bytes, less any leading zeros</span>
    <span class="n">signatureValue</span> <span class="o">=</span> <span class="n">signatureValue</span><span class="p">[</span><span class="o">-</span><span class="n">takeHowManyBytes</span><span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># This should give a signature length of 20 bytes, as mandated by the</span>
    <span class="c"># XML-Signature specification</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signatureValue</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">20</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SignatureGenerationException</span><span class="p">(</span><span class="n">signatureValue</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">signatureValue</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2 id="id1">ZSI<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>ZSI is a good SOAP library, but it sometimes lacks features already present in
other parts of the code.</p>
<p>I will briefly present two cases that exemplify this situation.</p>
<div class="section" id="signaturehandler">
<h3 id="signaturehandler">SignatureHandler<a class="headerlink" href="#signaturehandler" title="Permalink to this headline">¶</a></h3>
<p>As we know from <a class="reference internal" href="#ws-sec"><em>above</em></a>, ZSI has the ability to use a
<tt class="docutils literal"><span class="pre">SignatureHandler</span></tt> class as a filter for incoming and outgoing messages.</p>
<p>This is true for the <tt class="docutils literal"><span class="pre">Binding</span></tt>, which is a commonly used class for sending
messages where the model is already encoded as a Python object.</p>
<p>Using a <tt class="docutils literal"><span class="pre">ServiceProxy</span></tt> <a class="footnote-reference" href="#id3" id="id2">[1]</a>, however, there is no way to specify which object
should act as the <tt class="docutils literal"><span class="pre">SignatureHandler</span></tt>, even though, behind the scenes, the
<tt class="docutils literal"><span class="pre">ServiceProxy</span></tt> is doing nothing more than generating the models and creating a
<tt class="docutils literal"><span class="pre">Binding</span></tt>.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>A class that turns WSDL files into code at runtime, caching the result
to increase performance.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="xml-attributes">
<h3 id="xml-attributes">XML attributes<a class="headerlink" href="#xml-attributes" title="Permalink to this headline">¶</a></h3>
<p>XML attributes are used in one specific message, the <tt class="docutils literal"><span class="pre">Subscribe</span></tt> method of
OSCARSNotify, to indicate the <tt class="docutils literal"><span class="pre">Dialect</span></tt> of the two elements
<tt class="docutils literal"><span class="pre">&lt;TopicExpression&gt;</span></tt> and <tt class="docutils literal"><span class="pre">&lt;ProducerProperties&gt;</span></tt>.</p>
<p>Apparently, ZSI provides no easy way to encode these attributes using a Python
structure (the usual dictionary), but requires instantiation of classes to hold
these values.</p>
<p>To get around this problem, I extended the syntax of ZSI simple types to also
accept 2-tuples holding the attribute name and its value.</p>
<p>For example, let us have a look at a sample <tt class="docutils literal"><span class="pre">Subscribe</span></tt> message, generated
using the <tt class="docutils literal"><span class="pre">MessageBuilder</span></tt>:</p>
<div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">MessageBuilder</span><span class="o">.</span><span class="n">buildSubscribeMessage</span><span class="p">(</span><span class="s">&#39;consumer&#39;</span><span class="p">,</span> <span class="s">&#39;topic&#39;</span><span class="p">,</span> <span class="s">&#39;producer&#39;</span><span class="p">)</span>

<span class="go">{&#39;ConsumerReference&#39;: {&#39;Address&#39;: &#39;consumer&#39;},</span>
<span class="go"> &#39;Filter&#39;: {&#39;ProducerProperties&#39;: [[(&#39;Dialect&#39;,</span>
<span class="go">                                     &#39;http://www.w3.org/TR/1999/REC-xpath-19991116&#39;),</span>
<span class="go">                                    &quot;/wsa:Address=&#39;producer&#39;&quot;]],</span>
<span class="go">            &#39;TopicExpression&#39;: [[(&#39;Dialect&#39;,</span>
<span class="go">                                  &#39;http://docs.oasis-open.org/wsn/t-1/TopicExpression/Full&#39;),</span>
<span class="go">                                 &#39;topic&#39;]]}}</span>
</pre></div>
<p>As you can see, <tt class="docutils literal"><span class="pre">TopicExpression</span></tt> maps to a list of lists, each having the
required <tt class="docutils literal"><span class="pre">Dialect</span></tt> attribute and its value, and the actual value (the topic).
This also allows for creating two topics with a different <tt class="docutils literal"><span class="pre">Dialect</span></tt>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3>Table Of Contents</h3>
            <ul>
<li><a class="reference external" href="">Development issues</a><ul>
<li><a class="reference external" href="#soap">SOAP</a><ul>
<li><a class="reference external" href="#namespaces">Namespaces</a></li>
<li><a class="reference external" href="#faults">Faults</a></li>
</ul>
</li>
<li><a class="reference external" href="#ws-security-and-xml-dsig">WS-Security and XML-DSig</a><ul>
<li><a class="reference external" href="#xml-canonicalization">XML Canonicalization</a></li>
<li><a class="reference external" href="#signature-generation">Signature generation</a></li>
</ul>
</li>
<li><a class="reference external" href="#id1">ZSI</a><ul>
<li><a class="reference external" href="#signaturehandler">SignatureHandler</a></li>
<li><a class="reference external" href="#xml-attributes">XML attributes</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="receiver.html" title="previous chapter">OSCARSNotify receiver</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="help.html" title="next chapter">Getting help</a></p>
            <h3>Quick search</h3>
            <form class="search" action="search.html" method="get">
              <input type="text" name="q" size="18" /> <input type="submit" value="Go" />
              <input type="hidden" name="check_keywords" value="yes" />
              <input type="hidden" name="area" value="default" />
            </form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="help.html" title="Getting help"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="receiver.html" title="OSCARSNotify receiver"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">PyOSCARS v1.0 documentation</a> &raquo;</li>
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright Gianluca Campanella.
      Last updated on Aug 14, 2008.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
    </div>
  </body>
</html>