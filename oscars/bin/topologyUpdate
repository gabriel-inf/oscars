#!/usr/bin/perl -w

use strict;

use SOAP::Lite;
use Data::Dumper;

use OSCARS::ClientManager;
use OSCARS::PluginManager;

my $configFile = $ENV{HOME} . '/.oscars.xml';
my $pluginMgr = OSCARS::PluginManager->new('location' => $configFile);

# sign using user's certificate
$ENV{HTTPS_CERT_FILE} = $ENV{HOME}."/.globus/usercert.pem";
$ENV{HTTPS_KEY_FILE}  = $ENV{HOME}."/.globus/userkey.pem";
# tells WSRF::Lite to sign the message with the above cert
$ENV{WSS_SIGN} = 'true';

my $clientMgr = OSCARS::ClientManager->new();

my( $status, $msg ) = topologyUpdate();
print STDERR $msg;


#############################################################################
#
sub topologyUpdate {

    my $params = {};
    $params->{directory} = '/home/oscars/ifrefpoll';

    my $methodName = 'topologyUpdate';
    my $client = $clientMgr->getClient($methodName);
    my $method = SOAP::Data -> name($methodName)
        -> attr ({'xmlns' => 'http://oscars.es.net/OSCARS/Dispatcher'});
    my $request = SOAP::Data -> name($methodName . "Request" => $params );
    my $som = $client->call($method => $request);

    if ($som->faultstring) { return( 0, $som->faultstring ); }
    my $results = $som->result;
    my $msg = "\nStatus: Successfully updated router tables.\n";
    $msg .= Dumper($results);
    return( 1, $msg );
} #___________________________________________________________________________
