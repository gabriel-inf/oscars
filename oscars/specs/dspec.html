<html>
<title>OSCARS Reservation Manager Design Specification</title>
</head>
<body>
<h2>OSCARS Reservation Manager Design Specification</h2>

<h3>Year 2 Update (DRAFT)</h3>

<em>David Robertson, Chin Guok</em><br/>
<a href="http://www.es.net/">ESnet</a><br/><br/>

April 25, 2006</br>

<h2>Introduction</h2>

<p>This document focuses on the design decisions made for implementing the 
<a href="https://oscars.es.net/specs/fspec.html">requirements</a> 
for the reservation manager (RM) portion of 
<a href="http://www.es.net/oscars">OSCARS</a>.
A parenthesized indicator following a feature description shows the year of
the project the feature was or will be completed.  Note that y3 
requirements depend on additional funding.</p>

<p>Portions of this document are taken from the OSCARS
<a href="http://www.es.net/oscars/documents/OSCARS.pdf">project summary</a>.
Specifications have been updated based on lessons learned thus far.</p>

<p>Design specifications take into account the fact that security is absolutely 
essential, for reasons stated in the 
<a href="https://oscars.es.net/specs/fspec.html#security">requirements</a>.
During the following discussion of the RM's components, security implications 
are postponed until the final
<a href="https://oscars.es.net/specs/dspec.html#security_dr">section</a>.</p>

<p>The 
<a href="http://discvenue.internet2.edu/">BRUW</a>
Web pages, including CGI forms, were used as the starting point for the 
interface design and necessary functionality.  (BRUW is an experimental 
Internet2 bandwidth reservation system.) 


<h2>Web Service Components</h2>

<p>One of the primary design decisions is to implement the RM as a Web
service.  Web services (WS) standards are used wherever possible, including 
SOAP for transport (y1), and WSDL for service description (y2).  Client
requests are mapped to the proper RM component through the method name
and port in the service description (y2).</p>

<p>Different instances of the RM, for example in different organizations, 
communicate via their respective RM's through the setup of federated trust 
(y2/y3).</p>

<p>The other primary decision is to use the functionality of the Apache Web
server as much as possible.  Apache provides a number of services out of the
box, which is important for a project with a limited number of personnel.
Also, it is extensively monitored by the open-source community for any
security problems.</p>

<h2>Transport</h2>

<p><a href="http://www.w3.org/TR/soap/">SOAP</a> messages are used for
communication between all clients and the RM.  Identical SOAP messages to the 
RM are generated, whether using the interactive interface (y1) or the API (y2).
The SOAP::Lite package is used to handle SOAP calls.  Clients make SOAP calls 
through the use of URL's which are mapped to the server handling the calls
by some simple configuration of the Apache Web server.  Examples of the 
appropriate directives are provided with the OSCARS distribution. (y2)</p>

<p>The methods available through the RM  are described via the 
Web Service Definition
Language (<a href="http://www.w3.org/TR/wsdl">WSDL</a>).  WSDL provides for
definitions of data types for message arguments using XML Schema, and
definitions of request and response messages.  A service description
is only publicly available for methods available via the API.  Internal
methods are also described via WSDL, for documentation and consistency,
but this latter description is only for internal use.  (y2)</p>


<h2>Database</h2>

<p>The MySQL 5 database server is used.  The database schemas used the BRUW 
schema as a starting point.  Communication with the database is handled via 
the Perl DBI package.  Securing the database server is discussed in the final 
<a href="https://oscars.es.net/specs/dspec.html#security_dr">section</a>.
(y1, y2)</p>

<p>Within the MySQL server, there is a main OSCARS database, and a topology 
database describing the current ESnet routers.  Note that these may be 
combined at a later date. (y1, y2)</p>


<h2>User Interface</h2>

<h3>Interactive interface</h3>

<p>The interactive user interface to the RM is a Web-Based User Interface 
(WBUI), i.e., a browser.  The specific mode of interaction is via CGI form
submission to a user-accessible Web server, which in turn forwards the requests 
to the internal RM SOAP server.  (y1, y2)</p>

<p>All forms have three areas:  a banner area, a status area, and a main area 
for the primary functionality, with a line of navigation tabs at its top.
(y1)</p.

<p>If an error occurs during the processing of a user request, a SOAP
faultstring is returned to the entity which made the SOAP call. 
This error message is displayed in the status area, and the main area is
unchanged.  If no error occurred, new information is displayed in the main
area depending on which form was submitted. (y1)</p>

<p> Clicking on a tab on the navigation bar takes the user to a corresponding
form.  The requests listed in the 
<a href="https://oscars.es.net/specs/fspec.html#require">requirements</a> 
are mapped to forms as follows:</p>


<h3>AAA-related forms</h3>

<ul>
<li>The "login" form handles the request to login, and is the only page that 
is currently viewable by a non-authenticated user.  On the login form, a user 
authenticates via his or her email address and password (y1).  
</li><br/>

<li>After a successful login, the request for information about OSCARS is
handled by displaying that information in the main area.  Clicking on
the "Info" tab at any time brings that information up again. (y1)
</li><br/>

<li>The "User profile" form handles the request to list the details of a
user's account, and the request to modify the details of a user's account.
(y1, y2)
</li><br/>

<li>The "Logout" tab handles the request to log a user out.  There is no 
associated form.  Clicking on that tab takes the user to the initial login 
page. (y1)
</li>

<p>The following occurs if a user has the "Manage" authorization:</p>

<li>The "Users" tab appears instead of the "User profile" tab in the line of 
navigation tabs at the top of a form.
Clicking on that tab brings up the "Users" form, which handles the 
request to list all user accounts.  This form
allows for the deletion of any user account.  The user profile page for any 
user is accessible via this form, allowing for modification of
any user's information.  The "Add User" form is also accessible through 
the "Users" form, and allows for the addition of a new OSCARS user. (y1, y2)
</li><br/>

</ul>


<h3>Intradomain-related forms</h3>

<ul>

<li>The "Create Reservation" form handles the request to create a reservation.
If the request is successful, the details of that reservation are displayed
in the main area. (y1)
</li><br/>

<li>The "Reservations" form handles the request to view a list of a user's 
pending, active, cancelled, and finished reservations.  The request to view a 
reservation's details is handled through the ability to click on a link 
available from each reservation, bringing up that reservation's details in the 
main area of the form.  Requests to modify or cancel a reservation are 
available through this details page. 
If the user has the "Manage" authorization, the "Reservations" form
lists all clients' reservations, and allows getting the details of any 
client's reservation, and cancelling or modifying any client's reservation.
(y1, y2)
</li>
</ul>

<h3>API</h3>

<p>Requests made via the API use the same WSDL description as the targets
of CGI form submission.  All requests listed in the
<a href="https://oscars.es.net/specs/fspec.html#require">requirements</a> 
that indicate they can use the API are exposed.   All other methods are
accessible only for testing purposes on the machine where the OSCARS server is 
running.  (y1, y2)</p>

<p>Clients send SOAP messages to the user accessible Web server, which then 
forwards it to the RM SOAP server.  If an error occurs during the processing of
a client request, a SOAP faultstring is returned to the client which made the 
call. (y1, y2)</p>

<a id="RM">
<h2>RM</h2>

<p>The RM consists of an Apache2 Web server configured for mod_perl,
two databases within the MySQL 5.0 server as mentioned above, and a set of Perl 
packages that handle calls dispatched using mod_perl (y1, y2).
</p>

<p>The process of making and scheduling a reservation is as follows
(authentication and authorization details are handled in the security
<a href="https://oscars.es.net/specs/dspec.html#security_dr">section</a>):</p>

<ol>
<li>Interactive interface:</li><br/>

<ul>
<li>The user goes to the "Create Reservation" form by clicking on the tab of 
that name on the navigation form. (y1)</li><br/>

<li>The user fills in mandatory and any optional fields listed in the 
<a href="https://oscars.es.net/specs/fspec.html#resv">requirements</a>,
and submits the reservation request. (y1)</li><br/>

<li>The target of the request (on the user-accessible Web server) makes a
SOAP call to the RM SOAP server. 
(y2)</li><br/>
</ul>
</li>

<li>API:</li><br/>
<ul>
<li>A client makes a SOAP call to the user-accessible Web server with
the parameters specified in the WSDL for the reservation request. 
(y2)</li><br/>

<li>The server forwards this request to the RM SOAP server. (y2)</li><br/>
</ul>
</li>

<li>After authentication and authorization, the IC handles the request (y1).
</li><br/>

<li>After checking for valid fields, the IC executes a traceroute to find
the path to take within ESnet, based on the source and destination.
During that process, the IC finds the ingress and egress ESnet routers, if 
they have not already been specified by a client that has the 
network engineer permission. (y1, y2)
</li><br/>

<li>Before entering the reservation in the IC's database, the IC checks
to make sure that none of the links in the path are oversubscribed.  If they
are, an error message is returned to the client. (y1)
</li><br/>

<li>The IC next creates a row in the database containing the information
for the reservation.  Reservations are identified to the client by unique 
tags which are generated by concatenating a user's email address, the date and 
time, and the primary key of the row in the database. (y1)
</li><br/>

<li>Upon successfully entering the reservation, the IC returns a "success"
message and the reservation details to the client (y1).
</li><br/>
 
<li>A cron script periodically polls the database to see if reservations have 
become current, in which case the PSS library is called to set up the 
label-switched path (LSP).  The script also polls to see if a reservation has 
expired, at which point a call is made to the PSS library to tear down the 
LSP. (y1)
</li><br/>
</ol>


<a id="PSS">
<h2>PSS</h2>

<p>The PSS uses 
<a href="http://www.juniper.net/support/junoscript/">Junoscript</a>
to configure Juniper routers (y1), and 
<a href="http://www.shrubbery.net/rancid/">RANCID</a> (y2)
to configure Cisco routers.  The PSS sets up the LSP, checks for non-valid 
paths, and tears down the LSP (y1, y2).</p>


<a id="security_dr">
<h2>Security</h2>

<p>An Apache2 Web server on an open ESnet machine is used to forward all 
requests to the internal OSCARS Web server through the ProxyPass and 
ProxyPassReverse configuration directives.  (This machine also forwards OSCARS 
Subversion code repository requests.) This forwarding process is transparent to
the end user (y2)</p>

<p>The RM runs on a machine for which a firewall filter has been set up.
Only ESnet and LBNL personnel's machines are included in the acl's.  The
OSCARS CGI scripts only accept requests from the open Web server. (y1, y2)</p>

<p>The RM SOAP server only accepts requests from CGI scripts on the same
machine, or for requested URL's that contain the string 'OSCARS' at the start 
of their path.  The latter case occurs when the API is used.  The
ProxyPass and ProxyPassReverse mechanism is used, this time on the internal 
Web server, to map the URL to one that contains the port number of the RM SOAP 
server.  Authentication in this latter case is described below (y1, y2)
</p>

<p>The internal Web server only accept https connections.  httpd processes 
run as an unprivileged user without a login shell.  Web server startup and 
shutdown are handled by rc.d scripts. (y1, y2)</p>

<p>Database server processes run as an unprivileged user without a login 
shell.  The server only accepts requests from database clients running on the 
same machine (i.e. the RM SOAP server).  MySQL is configured with the 
--skip-networking option to ensure this.  Database server startup and shutdown 
are handled by rc.d scripts.  (y1, y2)</p>


<h3>Authentication</h3>

<h4>Interactive interface</h4>

<p>Users currently must have an OSCARS account to use the interactive 
interface.  They must provide their user name and password via the initial 
login form.  The target of the form submission sends a SOAP message to the RM,
which makes a call to the oscars database to see if the user's name exists, 
and whether the password matches.  If so, the user's DN is returned to the 
calling entity, and stored using the Perl CGI::Session package.  The cookie 
sent to the browser contains a reference to that information, rather than the 
information itself.  The cookie times out after 8 hours. (y1, y2)</p>

<p>After successful login, subsequent form submissions retrieve the
user's DN from the cookie.  The DN is passed along in the SOAP call to
the RM server.  The server requires the DN for anything besides login 
requests. (y1, y2)</p>

<h4>API</h4>

<p>Signed SOAP messages are required for all API requests.  The OSCARS Web 
server runs openssl code to validate the certificate and extract the 
associated user's DN.  Upon successful authentication, the next step is
authorization, using the user's DN. (y2).</p>


<h3>Authorization</h3>

<p>The Resource Oriented Authorization Manager (ROAM) is taken as the
model for handling authorization.  Authorization is handled using the
Users, Resources, ResourcePermissions, and Authorizations tables.  Current
resources are "Users", "Reservations", "Domains", and individual routers.
Current permissions are "manage", "persistent", "set", and "view".
The Authorizations table contains triplets of user/resource/permission
combinations.  A lookup is done against the authorizations table, given the 
user's login, to see if that user has a specific permission to use a 
particular resource.
</p>

<p>All operations that require authorization require an OSCARS account.  Only 
about 15 to 20 people are anticipated to require use of these operations. 
(y2)</p>


<h3>Auditing</h3>

<p>The RM uses ESnet production tools to monitor usage (y3).  Notifications of 
successful reservation creation, and LSP setup and tear down (see PSS 
<a href="https://oscars.es.net/specs/dspec.html#PSS">section</a>)
are done via email to the appropriate ESnet personnel (y1).</p>


<h3>Risks</h3>

<p>As simple as possible a solution has been chosen for security, while
attempting to minimize risk.  If OSCARS is difficult to use, or
difficult to install, then it won't be used.</p>

<p>The primary risks are the open machine running the user-accessible Web
server being compromised, and/or the session ID for the cookie containing
a user's DN being discovered and used to execute OSCARS operations.
</p>

<p>The 
<a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/securing-freebsd.html">Securing FreeBSD</a> guidelines will be followed for the
OSCARS machine.  A firewall filter will be set up allowing
only port 443 access from the open Web server to the OSCARS machine. (y2)</p>

<p>The cookie will initially be set to timeout after eight hours to limit
the exposure from a compromised session key.</p>

</body>
</html>
