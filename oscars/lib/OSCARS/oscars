#!/usr/bin/perl -w

#==============================================================================
package OSCARS::Server;

use SOAP::Transport::HTTP;

use strict;
use Data::Dumper;

use OSCARS::ResourceManager;

my $len = scalar(@ARGV);
if ($len != 1) {
    print STDERR "Usage:\t\toscars component_name\n";
    print STDERR "Example:\toscars AAAS\n";
    exit;
}

my $server_name = $ARGV[0];
my $resource_manager;

if ($server_name) {
    start_server($server_name);
}

###############################################################################
#
sub start_server {
    my ( $server_name ) = @_;

    $resource_manager = 
                   OSCARS::ResourceManager->new('server_name' => $server_name);
    my $portnum = $resource_manager->get_daemon_info();

    # set up proxy if it will be necessary to forward requests
    # TODO:  fix hard-wiring 
    #my( $uri, $proxy ) = $resource_manager->get_proxy_info('BSS');
    #if ($proxy) { $resource_manager->set_proxy($uri, $proxy); }

    if ($server_name) {
        $SOAP::Constants::MAX_CONTENT_SIZE = 10000;
        my $daemon = SOAP::Transport::HTTP::Daemon
            -> new (LocalPort => $portnum, Listen => 5, Reuse => 1)
            -> dispatch_to('OSCARS::Dispatcher');
        $daemon->handle;
    }
} #____________________________________________________________________________


#==============================================================================
package OSCARS::Dispatcher;

=head1 NAME

OSCARS::Dispatcher - SOAP::Lite dispatcher for OSCARS.

=head1 SYNOPSIS

  use OSCARS::Dispatcher;

=head1 DESCRIPTION

Dispatcher for SOAP::Lite.

=head1 AUTHOR

David Robertson (dwrobertson@lbl.gov)

=head1 LAST MODIFIED

January 30, 2006

=cut

use Error qw(:try);
use Data::Dumper;
use SOAP::Lite;

use strict;

use OSCARS::ResourceManager;
use OSCARS::Method;


###############################################################################
#
sub dispatch {
    my ( $class_name, $params ) = @_;

    my( $ex );
    my $results = {};
    my( $user, $handler );

    try {
        if (!$resource_manager->authenticate($params)) {
            throw Error::Simple(
                "User $params->{user_dn} not able to authenticate to make $params->{method} call");
        }
        if (!$resource_manager->authorized($params)) {
            throw Error::Simple(
                "User $params->{user_dn} not authorized to make $params->{method} call");
        }
        # if handler is present on this server
        #if ($server_name eq $params->{server_name}) {
        if (1) {
            $user = $resource_manager->get_user($params->{user_dn});
            $user->connect($params->{server_name});
            my $factory = OSCARS::MethodFactory->new();
            $handler = $factory->instantiate( $user, $params );
            my $err = $handler->validate();
            if ($err) { throw Error::Simple($err); }
            # call SOAP method
            $results = $handler->soap_method();
         }
         # Method is not on this server.  Forward to the correct one.
         else {
             my $som = $resource_manager->forward($params);
             $results = $som->result;
         }
    }
    catch Error::Simple with { $ex = shift; }
    otherwise { $ex = shift; }
    finally {
        if ($ex) {
            print STDERR $ex->{-text}, "\n";
            if ( !$handler ) {
                $resource_manager->write_exception($ex->{-text},
                                                   $params->{method}),
            }
            else {
                $handler->write_exception($ex->{-text}, $params->{method});
            }
                # caught by SOAP to indicate fault
            die SOAP::Fault->faultcode('Server')
                 ->faultstring($ex->{-text});
        }
        elsif ($handler) { $handler->post_process($results); }
    };
    return $results;
} #____________________________________________________________________________


######
1;
