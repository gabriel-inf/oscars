<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>OSCARS Message Security</title>
  <style type="text/css">
body {
margin-left: 7%;
margin-right: 5%;
}
</style>
</head>

<body>
<h2>OSCARS Message Security</h2>
<h3>Overview</h3>
The OSCARS Web pages and Web Services are run within a Tomcat container which uses SSL connections
to encrypt all messages. The Web Service interfaces are run via an axis2 service within the
Tomcat container that has message signing implemented by the Rampart software. The SSL connection assures
the user that he is connecting to a legitimate OSCARS server, and encypts all data that passes between 
the client and the server. The message signing assures the OSCARS server that the request came from
an authenticated user that can be matched against its list of authorized users. Signed messages are required 
rather than SSL client authentication, because there may be more than one host machine between the client
and the OSCARS sevice. Signed messages assure end-to-end authentication, where SSL does only point-to-point
authentication.
<p>
The client needs to have access to a private key and its matching X509 certificate for message signing,
and the the X509 certificate chain of the server that it is contacting. The Tomcat server needs access 
to a private key and X509 certificate to identify itself to the client and to encyrpt the SSL connection.
The OSCARS service needs the X509 certificates of the users in order to authenticate the message signature.
<p>
There is an additional complication presented by the interdomain architecture. The OSCARS server and OSCARS
scheduler in each domain will also act as a client when information about a reservation needs to be forwarded
to an ajacent domain. Thus on an OSCARS server host there will be both server and client configurations.
<p>
Since all of the code is in Java, the private keys and certificates are kept in Java Keystore files, and 
the configuration infomation is kept in properties files.

<h3>Configration Files</h3>
<ul>
   <li><b>axis2.xml</b> Used by axis2 client. <br>
      Names the security.properties file (sec-client.properties); the user
      who will sign the message; specfies that outFlow messages are to be signed
      and time stamped and that inflow messages are to be time stamped. This file is found by
      setting the -Daxis2.xml=&lt;pathname&gt; Java option, or programatically by a 
      System.setProperty("axis2.xml",&lt;pathname&gt; ). The pathname must be on the classpath. An absolute 
      pathname does not seem to work.<p>
      
   <li><b>services.xml</b> Used by an axis2 service. <br>
     Names the security.properties file to use on
     the server side (sec-server.properties). Specifies that inFlow messages are signed
     and time stamped and outFlow messages are time stamped. Found in the service.aar file 
     in META-INF/services.xml.<p>
     
   <li><b>sec-client.properties </b> Used by axis2 client. <br>
     Contains the name and password of the keystore that the client uses when signing a message. 
     Its name is specified in axis2.xml.
     This file must be on the classpath of the client.
     <p>   
   <li><b>sec-server.properties </b> Used by an axis2 service. <br>
     Contains the name and password of the keystore that the server will use to verify signed messages.
     Its name is sepecified in services.xml. This file must be on the services's classpath.
     (it is put in the classes file of OSCARS.aar)
     <p>
   <li><b>repo/sec-client.properties </b> Used by the OSCARS service when it is acting as
     a client when forwarding a request to an adjacent domain. <br>
     Contains the name and password of the keystore 
     used when signing a forwarded message. The messages are signed by the server credential: 
     oscars-dev.es.net or oscars-test.es.net. The name of this file is specified in 
     $CATALINA_HOME/shared/oscars.conf/axis2.repo/axis2.xml). This file must be on the classpath of the server.
     It is also used by the scheduler when contacting an adjacent domain to instantiate the routing requst.
     The ant setupserver task will put it in $CATALINA_HOME/shared/classes/repo.
     <p>
   </ul>
<h3> Keystore files</h3>
<ul>
   <li><b>sec-client.jks</b> Used by axis2 client. <br>
     Contains a key entry for the client that is signing the message and 
     trusted cert entries for any trusted CAs, e.g. any CAs in the chain that signed the users 
     certificate. File is named in sec-client.properties. Must be on the classpath.
     <p>
    <li><b>sec-server.jks</b> Used by axis2 server. <br>
     Contains the trusted cert entries for any trusted CAs, e.g. any CAs in the chain that signed the users 
     certificate. File is named in sec-server.properties. Must be on the classpath.
     <p>   
   <li><b>ssl-keystore.jks</b>- used by the client when establishing an ssl connection to a Tomcat
   	 server. <br>
   	  It needs to contain trustedCert entries for the server and its issuer chain. e.g. 
   	 oscars-dev.es.net, oscars-test.es.ent, "ESnet SSL Server Certificates" and "ESnet Root CA 1"
     Location hard-coded into KeyManagement.java as 
     	System.setProperty("javax.net.ssl.trustStore",repo +"/ssl-keystore.jks");
     where repo is an input string to setKeyStore(String repo). 
     <p>     
    <li><b>/root/.keystore</b> Used by the Tomcat server. <br>
      The keystore used by the Tomcat server when accepting the ssl
      connection. The name is specified in $CATALINA_HOME/conf/server.xml as the keystoreFile.
      It must contain a keyEntry for the server (possibly with the alias tomcat) e.g. oscars-dev.es.net 
      and trustedCert entries for the issuers of that cert.
      <p>
 </ul>
 <h3> Class Files </h3>
 <ul>
    <li><b>net/es/oscars/client/security/PWCallback.java</b>Called by <br>
     contains the password for the keys in  sec-client.jks.  Must be on classpath.
    <p>
    <li><b>net/es/oscars/client/security/KeyManagement.java</b>Called by <br>
      Sets the name and the password for the ssl-keystore.jks file.
</ul>
<h3>Client side</h3>
   Needs an axis2.xml file to generate signed messages.
   <p>
   Needs  sec-client.properties to define the keystore file and password.
   <p>
   Needs sec-client.jks with the keyEntry for the user who will be signing messages.
       For the user this should be a file with just the trustedCertEntries to
       which the user adds his key/cert. see <a href="exampleClients.html">exampleClients.html</a> for instructions on
       how to do this.
       <p>
   Needs ssl-keystore.jks to hold the trustedCert enties for the ssl connection to the Tomcat server.
   <i>The name and the password for this file are hard-coded into net.es.oscars.client.security.
        KeyManagement.</i>
   <p>
   The default ant task in examples/javaClients/build.xml will create and populate a repo directory 
   with all these pieces. The user may want to edit the axis2.xml to chose a different user to sign the messaage
   and may want to add additional keyEntries to sec-client.jks. Any edited files should be copied to someplace safe
   since the repo directory is purged and recreated each time ant is run.


<h3>Server side</h3>
  OSCARS needs the properties and keystore referenced in OSCARS.aar:META-INF/services.xml.<br>
  Services.xml comes from conf/public/server/services.xml. The properties and 
  keystore files are installed at the top level OSCARS.aar and come from conf/public/server.
  The keystore only needs trustedCertEntires since response messages are
     not signed.
<p>
  Tomcat needs the keystore referenced in ${catalina.home}/conf/server.xml to do server-side ssl. <br>
  If no keystoreFile entry is specified in the https connnector  element of server.xml, the file ~/.keystore is used.<br>
  If no keystorePass entry is specified the password is "changeit".<br>
  On oscars-dev keystoreFile element of the Connector for port 9090  is /root/.keystore. The keystore 
  contains a keyEntry for the oscars-dev  cert/key  with alias tomcat and the trustedcert entries for that key.
  
  <h3>Server acting as client, e.g when forwarding request to next Domain</h3>
   Needs trustedCertEnties and oscars-dev keyEntry, (not distributed outside
   of LBL in conf/private/sec-client.jks). The ant task setupServer will create a repo directory
   with the necessary axis2.xml, sec-client.properties and sec-client.jks in ${catalina.home}/shared/oscars.conf/axis2-repo
   directory.
  
</body>
</html>	
