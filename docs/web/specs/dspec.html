<html>
<title>OSCARS Reservation Manager Design Specification</title>
</head>
<body>
<h2>OSCARS Reservation Manager Design Specification</h2>

<h3>Year 3 Update (DRAFT)</h3>

<em>David Robertson, Chin Guok</em><br/>
<a href="http://www.es.net/">ESnet</a><br/><br/>

September 29, 2006</br>

<h2>Introduction</h2>

<p>This document focuses on the design decisions made for implementing the 
<a href="https://oscars.es.net/specs/fspec.html">requirements</a> 
for the reservation manager (RM) portion of 
<a href="http://www.es.net/oscars">OSCARS</a>.
This update, when completed, will include the design decisions made as part 
of the process of porting OSCARS to Java.</p>

<p><em>NOTE</em>: at this point, specification of items remaining to be
done this year is not complete.</p>

<p>Portions of this document are taken from the OSCARS
<a href="http://www.es.net/oscars/documents/OSCARS.pdf">project summary</a>.
Specifications have been updated based on lessons learned thus far.
Items with a (*) remain to be done this year.</p>

<p>Design specifications take into account the fact that security is 
absolutely essential, for reasons stated in the 
<a href="https://oscars.es.net/specs/fspec.html#security">requirements</a>.
During the following discussion of the RM's components, security implications 
are postponed until the final
<a href="https://oscars.es.net/specs/dspec.html#security_dr">section</a>.</p>

<p>The Internet2
<a href="http://discvenue.internet2.edu/">BRUW</a>
Web pages, including CGI forms, were originally used as the starting point 
for the interface design and necessary functionality.  Currently ESnet and
Internet2 staff are collaborating on a single code base (active work is now
in the Java language, with only bug fixes on the Perl branch).</p>


<h2>Use of Web Services</h2>

<p>A primary design decision is to implement the RM as a Web
service.  Web services (WS) standards are used wherever possible, including 
SOAP for transport, and WSDL for the service description.</p>

<p>Given the complexity of WS, existing support for them
has to be used as much as possible.  OSCARS was originally coded 
in Perl.  Perl provides functionality such as mod_perl, SOAP::Lite, Perl DOM 
packages, etc., and is not strongly typed, allowing for rapid development of a 
prototype.  Currently, most of the required functionality for the 
components of the RM has been implemented, and prototype interdomain
functionality has been implemented.  Successful interdomain tests have been 
run using OSCARS, Internet2, and TeraPaths.</p>

<p>However, most of our collaborators have developed complex WSDL service
descriptions.  Perl's handling of automatic code generation from complex WSDL
is immature.  Better coding tools have also become necessary, because more
functionality will be added to OSCARS, including more complex and functional
interdomain reservation setup.</p>

<p>Given this, OSCARS is in the process of being ported to Java (*).
Java has more mature support for WSDL and other WS standards, and extensive 
tools to develop Web applications.  Java allows the use of the Tomcat 
container, standard coding tools and helper applications such as Eclipse
and Hibernate, and libraries such as Axis (which provide for code 
generation from complex WSDL).
</p>

<h2>RM</h2>

<p>The RM consists of a Tomcat server, two databases within a MySQL 5.1 
server as described below, and a set of Java Server Faces pages, which
handle servlet functionality.  Two types of 
clients for the Tomcat server are implemented, one using browser-based Web 
forms, and the other using programmatic submission via an API.
The Tomcat server runs behind a firewall, and is accessible via proxying
through an open Apache Web server (security implications are discussed below).
</p>


<h3>Transport</h3>

<p>Browser-based clients send requests via Ajax submission.  When Tomcat 
receives a request via the Apache server, it dispatches it to the associated 
servlet based on the URL of the request.  The servlet extracts the
parameters from the request using a standard mechanism.</p>

<p>The API client uses <a href="http://www.w3.org/TR/soap/">SOAP</a> to 
make requests.  When Tomcat receives a SOAP request via the Apache server, 
Tomcat uses the URL to dispatch it to the appropriate servlet, which uses 
the Axis library to extract the parameters.</p>

<p>SOAP requests made via the API must conform to the Web Service Definition 
Language 
(<a href="http://www.w3.org/TR/wsdl">WSDL</a>) specification of the OSCARS 
service.  WSDL provides for
definitions of data types for message arguments using XML Schema, and
definitions of request and response messages.  A service description
is only publicly available for public BSS requests (done).  Internal
methods are also described via WSDL, for documentation and consistency,
but this latter description is only for internal use (*).</p>

<p>The mapping of a URL to a servlet is done via Tomcat XML configuration 
files.  Examples of the appropriate configuration are provided with the 
OSCARS distribution (*).</p>

<p>After the servlet has extracted the parameters, processing continues
in an identical fashion, regardless of the type of client performing the
request.</p>


<h2>Database</h2>

<p>The MySQL 5 database server is used.
Within the MySQL server, there is a main OSCARS database, and a topology 
database describing the current ESnet routers.</p>

<p>Much of the complexity of using a strongly typed language such as Java,
with the loading and storing of objects to database tables, is hidden using 
the Hibernate object/relational mapping application.
Hibernate greatly simplifies persisting Java objects to the MySQL
database, eliminating the need for porting a significant portion of 
the corresponding level of Perl code, which uses the Perl DBI (the conversion
to Hibernate is in progress).


<h2>Browser-based Client</h2>

<p>The interactive user interface to the RM is a Web-Based User Interface 
(WBUI), i.e., a browser.  The specific mode of interaction is via form
submission to the Apache server, which in turn forwards the 
requests to the Tomcat server.</p>

<p>All forms have three areas:  a banner area, a status area, and a main area 
for the primary functionality, with a line of navigation tabs at its top.</p>

<p>If an error occurs during the processing of a user request, a SOAP
faultstring is returned to the entity which made the SOAP call. 
This error message is displayed in the status area, and the main area is
unchanged.  If no error occurred, new information is displayed in the main
area depending on which form was submitted.</p>

<p> Clicking on a tab on the navigation bar takes the user to a corresponding
form.  The requests listed in the 
<a href="https://oscars.es.net/specs/fspec.html#require">requirements</a> 
are mapped to forms as follows:</p>


<h3>Authentication, Authorization, and Auditing (AAA) forms</h3>

<ul>
<li>The "login" form handles the request to login, and is the only page that 
is currently viewable by a non-authenticated user.  On the login form, a user 
authenticates via his or her email address and password.  
</li><br/>

<li>The "User profile" form handles the request to list the details of a
user's account, and the request to modify the details of a user's account.
</li><br/>

<li>The "Logout" tab handles the request to log a user out.  There is no 
associated form.  Clicking on that tab takes the user to the initial login 
page.
</li>

<p>The following occurs if a user has the "Manage" authorization:</p>

<li>The "Users" tab appears instead of the "User profile" tab in the line of 
navigation tabs at the top of a form.
Clicking on that tab brings up the "Users" form, which handles the 
request to list all user accounts.  This form
allows for the deletion of any user account.  The user profile page for any 
user is accessible via this form, allowing for modification of
any user's information.  The "Add User" form is also accessible through 
the "Users" form, and allows for the addition of a new OSCARS user.
</li><br/>

</ul>


<h3>Bandwidth Scheduler Subsystem (BSS) forms</h3>

<ul>

<li>The "Create Reservation" form handles the request to create a reservation.
If the request is successful, the details of that reservation are displayed
in the main area.
</li><br/>

<li>The "Reservations" form handles the request to view a list of a user's 
pending, active, cancelled, and finished reservations.  The request to view a 
reservation's details is handled through the ability to click on a link 
available from each reservation, bringing up that reservation's details in 
the main area of the form.  Requests to modify or cancel a reservation are 
available through this details page. 
If the user has the "Manage" authorization, the "Reservations" form
lists all clients' reservations, and allows getting the details of any 
client's reservation, and cancelling or modifying any client's reservation.
</li>
</ul>

<h2>API Client</h2>

<p>Requests made via the API must conform to the OSCARS WSDL description.
All requests listed in the
<a href="https://oscars.es.net/specs/fspec.html#require">requirements</a> 
that indicate they can use the API are exposed.   All other methods are
accessible only for testing purposes on the machine where the OSCARS server 
is running.</p>

<p>Clients send SOAP messages to the Apache server, which forwards them 
to the Tomcat server.  If an error occurs during the processing of a client 
request, a SOAP faultstring is returned to the client which made the call.</p>

<h2>Reservation Request Handling</h2>

<p>The process of making and scheduling a reservation is as follows:</p>

<ol>
<li>Interactive interface:</li><br/>

<ul>
<li>The user goes to the "Create Reservation" form by clicking on the tab of 
that name on the navigation form.
</li><br/>

<li>The user fills in mandatory and any optional fields listed in the 
<a href="https://oscars.es.net/specs/fspec.html#resv">requirements</a>.
</li><br/>

<li>
After client-side validation, the browser submits the request to the
publicly-accessible Apache server.
</li><br/>

<li>The Apache server forwards the request to the Tomcat server.  The
URL is inspected to determined what type of authentication is needed,
and the proper authentication is performed (see the
<a href="https://oscars.es.net/specs/dspec.html#security_dr">section</a>
on security).
</li><br/>
</ul>

<li>API:</li><br/>

<ul>
<li>A client makes a SOAP call to the Apache server with
the parameters specified in the WSDL corresponding to that request. 
</li><br/>

<li>The Apache server forwards the request to the Tomcat server.
</li><br/>

<li>The Apache server forwards the request to the Tomcat server.  The
URL is inspected to determined what type of authentication is needed,
and the proper authentication is performed.
</li><br/>
</ol>

<ol>

<li>At this point, the steps are the same for both types of clients.  After 
authorization, the Tomcat server uses the URL 
in the SOAP request to dispatch the request to the associated BSS servlet.
</li><br/>

<li>After checking for valid fields, the BSS executes a traceroute to find
the path to take within ESnet, based on the source and destination.
During that process, the BSS finds the ingress and egress ESnet routers, if 
they have not already been specified by a client that has the 
network engineer permission.
</li><br/>

<li>Before entering the reservation in the BSS's database, the BSS checks
to make sure that none of the links in the path are oversubscribed.  If they
are, an error message is returned to the client.
</li><br/>

<li>The BSS next creates a row in the database containing the information
for the reservation.  Reservations are identified to the client by unique 
tags which are generated by concatenating a user's email address, the date 
and time, and the primary key of the row in the database.
</li><br/>

<li>Upon successfully entering the reservation, the BSS returns a "success"
message and an identifier for the reservation back to the client.
</li><br/>

</ol>
 
<p>A cron script periodically polls the database to see if reservations have 
become current, in which case the Path Setup Subsystem (PSS) library is 
called to set up the label-switched path (LSP).  The script also polls to
see if a reservation has expired, at which point a call is made to the PSS 
library to tear down the LSP.</p>

<p>The PSS uses 
<a href="http://www.juniper.net/support/junoscript/">Junoscript</a>
to configure Juniper routers.  If it becomes necessary to configure Cisco
routers,
<a href="http://www.shrubbery.net/rancid/">RANCID</a>
will be used.  The PSS sets up the LSP, checks for non-valid 
paths, and tears down the LSP.</p>


<a id="security_dr">
<h2>Security</h2>

<p>The Apache Web server runs on an open ESnet machine, and forwards all 
requests to the internal Tomcat server through the ProxyPass and 
ProxyPassReverse configuration directives.  This forwarding process is 
transparent to the end user.</p>

<p>The Tomcat server runs on a machine for which a firewall filter has been 
set up.  Only ESnet and LBNL personnel's machines are included in the acl's.
The Tomcat server only accepts requests from the Apache server.</p>

<p>If a URL contains the string 'OSCARS' at the start of its path, the 
request is originating from the API.  The Tomcat server uses the presence
or absence of this string to determine how to perform authentication, which 
is described below.</p>

<p>The Apache and Tomcat servers only accept https connections.
Their associated processes run as an unprivileged user without a login shell.
Server startup and shutdown are handled by rc.d scripts.</p>

<p>Database server processes run as an unprivileged user without a login 
shell.  The database server only accepts requests from database clients 
running on the same machine as the Tomcat server.  MySQL is configured with 
the --skip-networking option to ensure this.  Database server startup and 
shutdown are handled by rc.d scripts.</p>


<h3>Authentication</h3>

<h4>Browser-based client</h4>

<p>Users currently must have an OSCARS account to use the interactive 
interface.  They must provide their user name and password via the initial 
login form.  The Tomcat server
makes a call to the oscars database to see if the user's name exists, 
and whether the password matches.  If so, the user's DN is returned to the 
calling entity, and stored using a session.  The cookie 
sent to the browser contains a reference to that information, rather than the 
information itself.  The cookie times out after 8 hours.</p>

<p>After successful login, subsequent form submissions retrieve the
user's DN from the cookie.  The DN is passed along in the Ajax request to
the Tomcat server.  The server requires the DN for anything besides login 
requests.</p>

<h4>API client</h4>

<p>Signed SOAP messages are required for all API requests.  The Tomcat
server runs openssl code to validate the certificate and extract the 
associated user's DN.  Upon successful authentication, the next step is
authorization, using the user's DN.</p>


<h3>Authorization</h3>

<p>The Resource Oriented Authorization Manager (ROAM) is taken as the
model for handling authorization.  Authorization is handled using the
Users, Resources, ResourcePermissions, and Authorizations tables.  Current
resources are "Users", "Reservations", "Domains", and individual routers.
Current permissions are "manage", "persistent", "set", and "view".
The Authorizations table contains triplets of user/resource/permission
combinations.  A lookup is done against the authorizations table, given the 
user's login, to see if that user has a specific permission to use a 
particular resource.
</p>

<p>All operations that require authorization require an OSCARS account.  Only 
about 15 to 20 people are anticipated to require use of these operations. 
</p>


<h3>Auditing</h3>

<p>The RM uses ESnet production tools to monitor usage (*).  Notifications of 
successful reservation creation, and LSP setup and tear down
are done via email to the appropriate ESnet personnel.</p>


<h3>Risks</h3>

<p>As simple as possible a solution has been chosen for security, while
attempting to minimize risk.  If OSCARS is difficult to use, or
difficult to install, then it won't be used.</p>

<p>The primary risks are the open machine running the Apache
server being compromised, and/or the session ID for the cookie containing
a user's DN being discovered and used to execute OSCARS operations.
</p>

<p>The 
<a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/securing-freebsd.html">Securing FreeBSD</a> guidelines will be followed for the
OSCARS machine.  A firewall filter is set up to only allow access from a 
specific port on the machine running the Apache server to the machine 
running the Tomcat server.</p>

<p>The cookie will initially be set to timeout after eight hours to limit
the exposure from a compromised session key.</p>

</body>
</html>
