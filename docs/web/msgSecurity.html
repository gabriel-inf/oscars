<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>OSCARS Message Security</title>
  <link rel="stylesheet" href="styleSheets/oscars.css" type="text/css">
  <link rel="shortcut icon" href="images/esnet.ico" type="image/x-icon">
</head>
<body>
<!--#include virtual="header.html" -->
<div id="topBar" class="topBar">
<div class="topBarDiv"> &nbsp;
<a href="index.html">home</a> &gt; <a href="install.html">Installing</a>
&gt; <a href="msgSecurity.html">Message
Security</a>
</div>
</div>
<h2><a class="mozTocH2" name="mozTocId599890"></a>OSCARS Message
Security</h2>
<h3><a class="mozTocH3" name="mozTocId581238"></a>Overview</h3>
The OSCARS Web pages and Web Services are run within a Tomcat container
which uses SSL connections
to encrypt all messages. The OSCARS Web Service interface is run as an
axis2 service within the
Tomcat container that has message signing implemented by the Apache
Rampart
software. The SSL connection assures
the user that he is connecting to a legitimate OSCARS server, and
encrypts all data that passes between the client and the server. The
message signing assures the OSCARS service that the request came from
an authenticated user that can be matched against its list of
authorized users. Signed messages are required rather than SSL client
authentication, because there may be more than one host machine between
the client
and the OSCARS service. Signed messages assure end-to-end
authentication, where SSL does only point-to-point
authentication.
<p>The client needs to have access to a private key and its matching
X509 certificate for message signing,
and the the X509 certificate chain of the server that it is contacting.
The Tomcat server needs access to a private key and X509 certificate to
identify itself to the client and to encrypt the SSL connection.
The OSCARS service needs a private key and X509 certificate to sign
responses and the X509 certificates of the CAs (Certificate
Authority) that issued&nbsp; users certificate
in order to authenticate the message signature.
</p>
<p>There is an additional complication presented by the interdomain
architecture. The OSCARS and OSCARSNotify servers in each domain will
also act as a client when information
about a reservation needs to be forwarded
to an adjacent domain. Thus on an OSCARS server host there will be both
server and client configurations.
</p>
<p>Since all of the code is in Java, the private keys and certificates
are kept in Java keystore files, and the configuration information is
kept in properties files.
</p>
<p>The rampart configuration file and keystore files contain
information
that is private to a domain
or user. The source code available from our <a href="subversion.html">code
repository</a> includes
samples of these files in the conf/examples directory. They
will need to be edited&nbsp;
to add the host and server certificates and user keys from your own
site.
</p>
<h3><a class="mozTocH3" name="mozTocId414171"></a>Configuration Files</h3>
<ul>
  <li><b>axis2.xml</b> Used by OSCARS client. <br>
    <span style="color: rgb(204, 0, 0);"></span><span
 style="color: rgb(204, 0, 0);"></span>Includes rampConfig.xml by
absolute pathname <span style="color: rgb(204, 0, 0);">which needs to
be edited by the site</span>.&nbsp; This file
is found by setting
the -Daxis2.xml=&lt;pathname&gt; Java option, or programatically by a
System.setProperty("axis2.xml",&lt;pathname&gt; ). The pathname must be
on the classpath. An absolute pathname does not seem to work.
    <p> </p>
  </li>
  <li><b>services.xml</b> Used by OSCARS and OSCARSNotify services. <br>
    <span style="color: rgb(204, 0, 0);"></span>Has the ws-policy
describing message security
and includes rampConfig.xml by absolute path name <span
 style="color: rgb(204, 0, 0);">which needs to be edited for the site</span>.&nbsp;
Has a list of each of the operations in the service, and what
policy applies to them. Copied from conf/server to the oscars.aar file
in
META-INF/services.xml by the ant <span
 style="font-weight: bold; font-style: italic;">aar</span> target. Also
copied from conf/notify-server to the oscars-notify.aar by the ant <span
 style="font-weight: bold; font-style: italic;">notifyaar</span>
target.
    <p> </p>
  </li>
  <li> <span style="font-weight: bold;">rampConfig.xml</span> Used by
the
OSCARS
client and server. Contains rampart specific ws-policy for message
security.
Contains the user alias, the keystore filename and password. <span
 style="color: rgb(204, 0, 0);">Needs to
be
edited for the site.</span>
    <p> </p>
  </li>
</ul>
<h3><a class="mozTocH3" name="mozTocId209738"></a> Keystore files</h3>
<ul>
  <li><b>OSCARS.jks</b> Used by OSCARS client and the server when
forwarding a request to another domain. Contains a <span
 style="font-style: italic;">keyEntry</span> for the entity that is
signing the message and <span style="font-style: italic;">trustedCertEntries&nbsp;
    </span>for the entity's CA.<span style="font-style: italic;"></span>
Must also have a
trustedCertEntry for the CA of the service that is being contacted in
order to verify the signature of the response message. File
is named in rampConfig.xml. Must be on the
classpath. It is copied from [conf/examples |
$DOMAIN_HOME]/server/OSCARS.jks to ${CATALINA_HOME}/shared/classes/repo
by the <span style="font-style: italic; font-weight: bold;">setupServer</span>
ant
task. File is named in
${CATALINA_HOME}/shared/classes/repo/rampConf.xml. The distributed file
contains trustedCertEntries for all the currently recognized CAs. <span
 style="color: rgb(204, 0, 0);">The site must add the KeyEntries for
the local service.</span>
    <p> </p>
  </li>
  <li><b>OSCARS.jks</b> Used by api client.<br>
Contains the KeyEntry for the client. Contains the <span
 style="font-style: italic;">trustedCertEtries</span>
for any trusted CAs, e.g. any CAs in the chain that signed the users
certificate. Also contains a keyEntry for the server which is used to
sign the response messages. Must
be on the classpath. It is copied from
[conf/examples|$DOMAIN_HOME]/server/ to examples/javaClients.repo&nbsp;
by examples/javaClients/build.xml. File is named in
examples/javaClients/repo/rampConf.xml. <span
 style="color: rgb(204, 0, 0);">The site must add the KeyEntries for
local api users.</span>
    <p> </p>
  </li>
  <li><b>ssl-keystore.jks</b>- used by the OSCARS client when
establishing an ssl connection to a Tomcat server. It needs to contain <span
 style="font-style: italic;">trustedCertEntries</span> for the server
and its issuer chain. e.g. oscars-dev.es.net or oscars.es.net, "ESnet
SSL Server Certificates" and "ESnet Root CA 1" Location hard-coded into
    <code>KeyManagement.java</code> as <code>System.setProperty("javax.net.ssl.trustStore",repo
+"/ssl-keystore.jks")</code>; where repo is an input string to <code>setKeyStore(String
repo)</code>. It is copied from [conf/examples/client/ to
$CATALINA_HOME/shared/classes/repo by the <span
 style="font-style: italic; font-weight: bold;">setupServer</span> ant
task and to examples/javaClient/repo by example/javaClient/build.xml.
    <p> </p>
  </li>
  <li><b>/root/.keystore</b> Used by the Tomcat server. <br>
The keystore used by the Tomcat server when accepting the ssl
connection. The name is specified in <code>$CATALINA_HOME/conf/server.xml</code>
as the keystoreFile. It must contain a <span
 style="font-style: italic;">keyEntry</span> for the server with the
alias Tomcat e.g. oscars-dev.es.net and <span
 style="font-style: italic;">trustedCertEntries </span>for the issuers
of that certificate. This file is created as part of the process of
configuring Tomcat for SSL.
    <p> </p>
  </li>
</ul>
<h3><a class="mozTocH3" name="mozTocId293790"></a> Class Files </h3>
<ul>
  <li><b>net/es/oscars/client/security/PWCallback.java</b> Called by <code>org.apache.rampart.handler.WSDoAllSender.processMessage</code>.
    <br>
Contains the password for the keys in <code>sec-client.jks</code>.
Must be on classpath.
    <p> </p>
  </li>
  <li><b>net/es/oscars/client/security/KeyManagement.java</b>&nbsp;
setKeyStore called by Client.setup and Forwarder.setup <br>
Sets the name and the password for the client-side <code>ssl-keystore.jks</code>
file. </li>
</ul>
<h3><a class="mozTocH3" name="mozTocId845833"></a>Client side</h3>
Needs an <code>axis2.xml</code> file to generate signed messages.<br>
<br>
The OSCARS[Notify] wsdl now specifies the message security properties.
That information is included in the OSCARS[Notify]Stub.java by
wsdl2java.<br>
<p> Needs <span style="font-family: monospace;">OSCARS</span><code>.jks</code>
with the <span style="font-style: italic;">keyEntry</span> for the
user who will be
signing messages and the <span style="font-style: italic;">trustedCertEntries</span>
for the issuers who signed the client cert and the certs of the OSCARS
service that he is contacting. <a href="keytool.html">Keytool</a> can
be used to create a keyEntry and to enter <span
 style="font-style: italic;">trustedCertEntries</span>.
tools/utils/copyKey.sh can be used to copy a keyEntry from an existing
key store.&nbsp; tool/utils/importKeyEntry.sh can be used to import a
keyEntry from a privateKey file in DER format and a cerificate chain in
DER format.<br>
</p>
<p> Needs <code>ssl-keystore.jks</code> to hold the <span
 style="font-style: italic;">trustedCertEntries</span> for the ssl
connection to the Tomcat server. The name and the password for this
file are hard-coded into<i> </i><code>net.es.oscars.client.security.KeyManagement.</code>
Use <a href="keytool.html">keytool</a> to add a <span
 style="font-style: italic;">trustedCertEntr</span>y for this
certificate. </p>
<p> The default ant task in examples/javaClients/build.xml will create
and populate a repo directory with all these pieces. The user may will
need
to edit <span style="font-family: monospace;">rampConfig</span><code>.xml</code>
to chose a a user to sign
the message and may want to add additional <span
 style="font-style: italic;">keyEntries</span> to <code>OSCARS.jks</code>.<br>
See <a href="keytool.html">keytool.html</a>
for instructions on how to do this.<br>
</p>
<h3><a class="mozTocH3" name="mozTocId734881"></a>Server side</h3>
<span style="color: rgb(204, 0, 0);"></span><span
 style="color: rgb(204, 0, 0);"></span><br>
<code> Services.xml</code> comes from <code>conf/server/services.xml
and is installed in the META-INF directory of the aar</code>.
It inlcudes rampConfig.xml which defines the rampart specific ws-policy
including the name of the keystore file, user and password.
RampConfig.xml and the keystore file (OSCARS.jks) are installed at
${catalina_home}/shared/classes/repo and are domain specific. The
ones for ESnet are checked into
https://oscars.es.net/esnet/domain. The ant target "setupServer" will
copy
them from <span style="font-family: monospace;"></span><code>[conf/examples/server|$DOMAIN_HOME/conf/server]
</code>into&nbsp;<code></code>${catalina_home}/shared/classes/repo.
Examples of
these files can be found in <code>examples/conf/server</code>. The
server
keystore needs <span style="font-style: italic;">trustedCertEntries</span>
for all the authorized user's certificate issuers to validate request
messages and keyEntry for the service to sign response
messages.
<p> Tomcat needs the keystore referenced in<code>
${catalina.home}/conf/server.xml</code> to do server-side ssl. <br>
If no keystoreFile entry is specified in the https connector element of
<code>server.xml</code>, the file <code>~/.keystore</code> is used. If
no keystorePass entry is specified the password is "changeit".<br>
On the oscars servers the keystoreFile element is specified as
/root/.keystore. The keystore contains a <span
 style="font-style: italic;">keyEntry</span> for the
oscars/oscars.es.net
cert/key with alias tomcat and the <span style="font-style: italic;">trustedCertEntries</span>
for the CAs in its certificate chain. </p>
<h3><a class="mozTocH3" name="mozTocId557506"></a>Server acting as
client, e.g when forwarding request to next Domain</h3>
Needs a client keystore with <span style="font-style: italic;">trustedCertEnties</span>
and service <span style="font-style: italic;">keyEntry</span>.
The ant task "<span style="font-style: italic;">setupServer</span>"
will create the <code>${catalina.home}/shared/classes/repo</code>
directory. The files&nbsp; <code>axis2.xml, rampConfig.xml, OSCARS.jks</code>
and <code>ssl-keystore.jks</code>
will&nbsp; be either copied from examples/conf/client or
$DOMAIN_HOME/conf/client by the <span
 style="font-weight: bold; font-style: italic;">setupServer</span> ant
task.<br>
<!--#include virtual="footer.html" -->
<br>
<br>
</body>
</html>
