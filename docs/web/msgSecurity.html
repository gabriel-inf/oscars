<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>OSCARS Message Security</title>
  <link rel="stylesheet" href="styleSheets/oscars.css" type="text/css">
  <link rel="shortcut icon" href="images/esnet.ico" type="image/x-icon">
</head>
<body>
<!--#include virtual="header.html" -->
<div id="topBar" class="topBar">
<div class="topBarDiv"> &nbsp;
<a href="index.html">home</a> &gt; <a href="install.html">Installing</a>
&gt; <a href="msgSecurity.html">Message
Security</a>
</div>
</div>
<h2><a class="mozTocH2" name="mozTocId599890"></a>OSCARS Message
Security</h2>
<ol id="mozToc">
<!--mozToc h2 2 h3 3 h5 5 h6 6--><li><a href="#mozTocId599890">OSCARS
Message
Security</a>
    <ol>
      <li>
        <ol>
          <li><a href="#mozTocId581238">Overview</a></li>
          <li><a href="#mozTocId414171">Configuration Files</a></li>
          <li><a href="#mozTocId209738"> Keystore files</a></li>
          <li><a href="#mozTocId293790"> Class Files </a></li>
          <li><a href="#mozTocId495270">Keystore Management Tools</a></li>
          <li><a href="#mozTocId734881">Server side</a></li>
          <li><a href="#mozTocId75136">Client
side</a></li>
        </ol>
      </li>
    </ol>
  </li>
</ol>
<h3><a class="mozTocH3" name="mozTocId581238"></a>Overview</h3>
The OSCARS Web pages and Web Services are run within a Tomcat container
which uses SSL connections
to encrypt all messages. The OSCARS Web Service interface is run as an
axis2 service within the
Tomcat container that has message signing implemented by the Apache
Rampart
software. The SSL connection assures
the user that he is connecting to a legitimate OSCARS server, and
encrypts all data that passes between the client and the server. The
message signing assures the OSCARS service that the request came from
an authenticated user that can be matched against its list of
authorized users. Signed messages are required rather than SSL client
authentication, because there may be more than one host machine between
the client
and the OSCARS service. Signed messages assure end-to-end
authentication, where SSL does only point-to-point
authentication.
<p>The client needs to have access to a private key and its matching
X509 certificate for message signing,
and the the X509 certificate chain of the server that it is contacting.
The Tomcat server needs access to a private key and X509 certificate to
identify itself to the client and to encrypt the SSL connection.
The OSCARS service needs a private key and X509 certificate to sign
responses and the X509 certificates of the CAs (Certificate
Authority) that issued users certificate
in order to authenticate the message signature.
</p>
<p>There is an additional complication presented by the interdomain
architecture. The OSCARS and OSCARSNotify servers in each domain will
also act as a client when information
about a reservation needs to be forwarded
to an adjacent domain. Thus on an OSCARS server host there will be both
server and client configurations.
</p>
<p>Since all of the code is in Java, the private keys and certificates
are kept in Java keystore files, and the configuration information is
kept in properties files.
</p>
<ol id="mozToc">
<!--mozToc h2 1 h3 2 h6 6-->
</ol>
<p>The rampart configuration file and keystore files contain
information
that is private to a domain
or user. The source code available from our <a href="SVNRepository.html">code
repository</a> includes
samples of these files in the conf/examples directory. They need to be
edited to add the host and server certificates and user keys from your own
site.
</p>
<h3><a class="mozTocH3" name="mozTocId414171"></a>Configuration Files</h3>
<ul>
  <li><b>axis2.xml</b> Used by OSCARS client and services <br>
    <span style="color: rgb(204, 0, 0);"></span><span
 style="color: rgb(204, 0, 0);"></span>Includes rampConfig.xml by
absolute pathname <span style="color: rgb(204, 0, 0);">(edited for the
site by ant setupServer)</span>.&nbsp; This file
is found by setting
the -Daxis2.xml=&lt;pathname&gt; Java option, or programatically by a
System.setProperty("axis2.xml",&lt;pathname&gt; ). The pathname must be
on the classpath. An absolute pathname does not seem to work.</li>
</ul>
<ul>
  <li><b>oscars-services.xml and notify-services.xml</b> Used by OSCARS and OSCARSNotify services. <br>
    <span style="color: rgb(204, 0, 0);"></span>Has the ws-policy
describing message security
and includes rampConfig.xml by absolute path name <span
 style="color: rgb(204, 0, 0);">(edited for the site by ant setupServer)</span>.&nbsp;
Has a list of each of the operations in the service, and what
policy applies to them. Copied from conf/axis-tomcat to the oscars.aar and notify.aar files
as META_INF/services.xml by the ant <span
 style="font-weight: bold; font-style: italic;">oscars-aar</span> and <span
 style="font-weight: bold; font-style: italic;">notify-aar </span> targets. 
  </li>
  <br>
  <li> <span style="font-weight: bold;">rampConfig.xml</span> Used by
the
OSCARS
client and services. Contains rampart specific ws-policy for message
security.
Contains the user alias, the keystore filename and password. <span
 style="color: rgb(204, 0, 0);">(edited for the site by ant
setupServer)</span>.
    <p> </p>
  </li>
</ul>
<h3><a class="mozTocH3" name="mozTocId209738"></a> Keystore files</h3>
<ul>
  <li><b>$CATALINA_HOME/shared/classes/repo/OSCARS.jks</b> Used by
OSCARS server when signing response messages and when
forwarding a request to another domain. Contains a <span
 style="font-style: italic;">keyEntry</span> for the entity that is
signing the message and <span style="font-style: italic;">trustedCertEntries</span> 
for the entity's CA. Must also have a
<span style="font-style: italic;">trustedCertEntry</span> for the CA of the service that is being 
contacted in order to verify the signature of the response message. File
is named in rampConfig.xml. Must be on the
classpath. It is copied from conf/axis-tomcat to ${CATALINA_HOME}/shared/classes/repo
by the <span style="font-style: italic; font-weight: bold;">setupServer</span>
ant task. The distributed file
contains trustedCertEntries for all the currently recognized CAs. <span
 style="color: rgb(204, 0, 0);">The site must add the KeyEntries for
the local service.</span>
    <p> </p>
  </li>
  <li><b>examples/javaClients/repo/OSCARS.jks</b> May be used by api
client.<br>
Contains the <span style="font-style: italic;">keyEntry</span> for the
client. Contains the <span style="font-style: italic;">trustedCertEtries</span>
for any trusted CAs, e.g. any CAs in the chain that signed the users
certificate. Must be on the classpath. It is copied from
conf/axis-tomcat to examples/javaClients/repo
by examples/javaClients/build.xml. File is named in
examples/javaClients/repo/rampConfig.xml which may either point to
$CATALINA_HOME/shared/classes/repo/OSCARS.jks or to repo/OSCARS.jks. <span
 style="color: rgb(204, 0, 0);">The site must add the KeyEntries for
local api users.</span>
    <p> </p>
  </li>
  <li><b>ssl-keystore.jks</b>- used by the OSCARS client when
establishing an ssl connection to a Tomcat server. It needs to contain <span
 style="font-style: italic;">trustedCertEntries</span> for the server
and its issuer chain. e.g. oscars-dev.es.net or oscars.es.net, "ESnet
SSL Server Certificates" and "ESnet Root CA 1". Location hard-coded into
    <code>KeyManagement.java</code> as <code>System.setProperty("javax.net.ssl.trustStore",repo
+"/ssl-keystore.jks")</code>; where repo is an input string to <code>setKeyStore(String
repo)</code>. It is copied from conf/axis-tomcat to
$CATALINA_HOME/shared/classes/repo by the <span
 style="font-style: italic; font-weight: bold;">setupServer</span> ant
task and to examples/javaClient/repo by examples/javaClients/build.xml.
    <p> </p>
  </li>
  <li><b>/root/.keystore</b> Used by the Tomcat server. <br>
The keystore used by the Tomcat server when accepting the ssl
connection. The name is specified in <code>$CATALINA_HOME/conf/server.xml</code>
as the keystoreFile. It must contain a <span
 style="font-style: italic;">keyEntry</span> for the server with the
alias Tomcat e.g. oscars-dev.es.net and <span
 style="font-style: italic;">trustedCertEntries </span>for the issuers
of that certificate. This file is created as part of the process of
configuring Tomcat for SSL.
    <p> </p>
  </li>
</ul>
<h3><a class="mozTocH3" name="mozTocId293790"></a> Class Files </h3>
<ul>
  <li><b>net/es/oscars/client/security/PWCallback.java</b> Called by <code>org.apache.rampart.handler.WSDoAllSender.processMessage</code>.
    <br>
Contains the password for the keys in <code>sec-client.jks</code>.
Must be on classpath.
    <p> </p>
  </li>
  <li><b>net/es/oscars/client/security/KeyManagement.java</b>&nbsp;
setKeyStore called by Client.setup and Forwarder.setup <br>
Sets the name and the password for the client-side <code>ssl-keystore.jks</code>
file.</li>
</ul>
<h3><a class="mozTocH3" name="mozTocId495270"></a><span
 style="font-weight: bold;"><a name="idcCommands"></a>Keystore
Management Tools</span></h3>
<br>
<div style="margin-left: 40px;"><a href="keytool.html"><span style="font-weight: bold;">keytool</span></a>:
available as part of the Java security package<br>
This is a general purpose keystore management program. use keytool -h
for a complete list of functions. It can be used to create a new
self-signed keyEntry, or to export a certificate signing request for
the new entries certificate to be sent to a CA for signing, and then
import the signed certificate back to the keyEntry. It can also import
a CA certificate to a trustedCertEntry,&nbsp; change the keystore
password and list the contents of a keystore.&nbsp; <br>
<br>
<span style="font-weight: bold;">tools/utils commands.<br>
</span>These commands are wrappers to keytool that operate on either of
${CATALINA_HOME}/shared/classes/repo/{OSCARS.jks,ssl-keystore}. They
take no arguments and prompt for the keystore, the alias you want to
see or modify and find the keystore password from the&nbsp;
rampConfig.xml file. <span style="font-weight: bold;"><br
 style="font-weight: bold;">
</span><span style="font-weight: bold;">idc-addcert:</span> creates a
new keyEntry, either with a signed or unsigned<br>
certificate, or imports a trusted CA certificate.<br>
<span style="font-weight: bold;">idc-certdel:</span> deletes a
trustedCertEntry or keyEntry from a keystore<br>
i<span style="font-weight: bold;">dc-export</span>: exports a pem
format X.509 certificate from either a trustedCertEntry or keyEntry.<br>
<span style="font-weight: bold;">idc-signreq:</span> exports a
certificate signing request for a keyEntry that currently contains a
self-signed certificate.<br>
<span style="font-weight: bold;">idc-certview:</span> views the
certificate associated with either a keyEntry or a TrustedCert entry.<br>
<span style="font-weight: bold;">idc-kspasswd:</span> Changes the
OSCARS.jks keystore password.<br>
<br>
<a name="copyKey"><span style="font-weight: bold;">tools/utils/copyKey:<br>
</span>Used to copy a keyEntry from one keystore to another. May be useful
when upgrading to a new release or when importing a keyEntry
from an externally obtained pkcs12 file.<br>
<br>
<code>copyKey.sh -a &lt;alias of keyEntry&gt; <br>
[-inpkcs12 &lt;filename of input
keyStore&gt;&nbsp; | -injks </code><code>&lt;filename of input
keyStore&gt; ]</code><br>
<code>-out &lt;filename of output keystore&gt;<br>
<br>
</code>It will prompt for the password of the input keystore, the
password of the keyEntry in the input keystore and the password for the
output key store. Normally the password of a keyEntry is the same the
keystore. If this is the case just reply with a CR. If the -inpkcs12
option is used the entry will be imported from a pkcs12 file. If -injks
is used it will be imported from another jks keystore.<br>
<br>
<span style="font-weight: bold;"></span><br>
<code></code><code><span style="font-weight: bold;"></span></code></div>
<h3><a class="mozTocH3" name="mozTocId734881"></a>Server side</h3>
<span style="color: rgb(204, 0, 0);"></span><span
 style="color: rgb(204, 0, 0);"></span><br>
<code> Services.xml</code> comes from <code>conf/axis-tomcat/oscars-services.xml,
notify-services.xml and is installed in the META-INF directory of the respective aar</code>.
It inlcudes rampConfig.xml which defines the rampart specific ws-policy
including the name of the keystore file, user and password.
RampConfig.xml and the keystore file (OSCARS.jks) are installed at
${catalina_home}/shared/classes/repo and are domain specific. The
ones for ESnet are checked into
https://oscars.es.net/esnet/domain/server. The ant target "setupServer" will
copy
them from <span style="font-family: monospace;"></span><code>[conf/axis-tomcat|$DOMAIN_HOME/server]
</code> into <code>${catalina_home}/shared/classes/repo</code>.
Examples of
these files can be found in <code>conf/axis2-tomcat</code>. OSCARS.jks
needs <span style="font-style: italic;">trustedCertEntries</span>
for all the authorized users' certificate issuers to validate request
messages and a <span style="font-style: italic;">keyEntry</span> for the service to sign response
messages.
<p> 
Tomcat needs the keystore referenced in<code>
${catalina.home}/conf/server.xml</code> to do server-side ssl. <br>
If no keystoreFile entry is specified in the https connector element of
<code>server.xml</code>, the file <code>~/.keystore</code> is used. If
no keystorePass entry is specified the password is "changeit".<br>
On the oscars servers the keystoreFile element is specified as
/root/.keystore. The keystore contains a <span
 style="font-style: italic;">keyEntry</span> for the
oscars/oscars.es.net
cert/key with alias tomcat and the <span style="font-style: italic;">trustedCertEntries</span>
for the CAs in its certificate chain. </p>
<br>
<h3><a class="mozTocH3" name="mozTocId75136"></a><code><a
 class="mozTocH3" name="mozTocId845833"></a></code>Client
side</h3>
Needs <code>axis2.xml</code>, rampConfig.xml and OSCARS.jks files to
generate signed messages.<br>
<br>
The OSCARS[Notify] wsdl now specifies most of the message security
properties.
That information is included in the OSCARS[Notify]Stub.java by
wsdl2java. rampConfig.xml specifies the Rampart specific message
security properties, e.g. the location of the keystore to use, the user
alias and password. axis2.xml imports rampConfig.xml<br>
<p> 
OSCARS.jks has the <span style="font-style: italic;">keyEntry</span> for the
user who will be signing messages and the <span style="font-style: italic;">trustedCertEntries</span>
for the issuers who signed the client cert and the certs of the OSCARS
service that he is contacting. <a href="keytool.html">Keytool</a> can
be used to create a keyEntry and to enter <span
 style="font-style: italic;">trustedCertEntries</span>.
<a href=#copyKey>tools/utils/copyKey.sh </a>can be used to copy a keyEntry from an existing
</p>
<p> Needs <code>ssl-keystore.jks</code> to hold the <span
 style="font-style: italic;">trustedCertEntries</span> for the ssl
connection to the Tomcat server. The name and the password for this
file are hard-coded into<i> </i><code>net.es.oscars.client.security.KeyManagement.</code>
Use <a href="keytool.html">keytool</a> to add a <span
 style="font-style: italic;">trustedCertEntr</span>y for this
certificate. </p>
The default ant task in examples/javaClients/build.xml will create
and populate a repo directory with all these pieces. The user may will
need
to edit <span style="font-family: monospace;">rampConfig</span><code>.xml</code>
to chose a a user to sign
the message and may want to add additional <span
 style="font-style: italic;">keyEntries</span> to <code>OSCARS.jks</code>.<br>
See <a href="keytool.html">keytool.html</a>
for instructions on how to do this.
<br>
<br>
</body>
</html>
